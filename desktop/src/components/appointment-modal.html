<!-- Randevu Oluştur/Düzenle Modal -->
<div id="appointment-modal" class="modal" style="display: none;">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h2 id="appointment-modal-title">Yeni Randevu Oluştur</h2>
      <span class="close" onclick="closeModal('appointment-modal')">&times;</span>
    </div>

    <form id="appointment-form" onsubmit="handleAppointmentSubmit(event)">
      <input type="hidden" id="appointment-id" name="id">

      <!-- Müşteri ve Cihaz Seçimi -->
      <div class="form-section">
        <h3>Müşteri ve Cihaz</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="appointment-customer">Müşteri *</label>
            <select id="appointment-customer" name="customerId" required onchange="loadAppointmentDevices(this.value)">
              <option value="">Müşteri seçiniz...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="appointment-device">Cihaz *</label>
            <select id="appointment-device" name="deviceId" required disabled>
              <option value="">Önce müşteri seçiniz...</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Randevu Bilgileri -->
      <div class="form-section">
        <h3>Randevu Bilgileri</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="appointment-date">Randevu Tarihi *</label>
            <input type="date" id="appointment-date" name="scheduledDate" required>
          </div>

          <div class="form-group">
            <label for="appointment-time">Randevu Saati *</label>
            <input type="time" id="appointment-time" name="scheduledTime" required>
          </div>

          <div class="form-group">
            <label for="appointment-duration">Tahmini Süre (dk)</label>
            <input type="number" id="appointment-duration" name="estimatedDuration" placeholder="60" min="15" step="15">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="appointment-type">Randevu Tipi *</label>
            <select id="appointment-type" name="appointmentType" required>
              <option value="">Seçiniz...</option>
              <option value="maintenance">Bakım</option>
              <option value="repair">Tamir</option>
              <option value="installation">Kurulum</option>
              <option value="inspection">Kontrol</option>
              <option value="consultation">Danışma</option>
            </select>
          </div>

          <div class="form-group">
            <label for="appointment-priority">Öncelik</label>
            <select id="appointment-priority" name="priority">
              <option value="normal">Normal</option>
              <option value="high">Yüksek</option>
              <option value="urgent">Acil</option>
              <option value="low">Düşük</option>
            </select>
          </div>

          <div class="form-group">
            <label for="appointment-status">Durum</label>
            <select id="appointment-status" name="status">
              <option value="scheduled">Planlandı</option>
              <option value="confirmed">Onaylandı</option>
              <option value="in_progress">Devam Ediyor</option>
              <option value="completed">Tamamlandı</option>
              <option value="cancelled">İptal Edildi</option>
              <option value="rescheduled">Ertelendi</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Teknisyen Atama -->
      <div class="form-section">
        <h3>Teknisyen Atama</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="appointment-technician">Teknisyen</label>
            <select id="appointment-technician" name="technicianId">
              <option value="">Teknisyen seçiniz...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="appointment-address">Randevu Adresi</label>
            <select id="appointment-address" name="addressType">
              <option value="customer">Müşteri Adresi</option>
              <option value="service_center">Servis Merkezi</option>
              <option value="other">Diğer</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Notlar -->
      <div class="form-section">
        <h3>Notlar ve Açıklamalar</h3>

        <div class="form-group">
          <label for="appointment-description">Randevu Açıklaması *</label>
          <textarea id="appointment-description" name="description" rows="3" required placeholder="Randevu detaylarını açıklayın..."></textarea>
        </div>

        <div class="form-group">
          <label for="appointment-notes">İç Notlar</label>
          <textarea id="appointment-notes" name="notes" rows="2" placeholder="Teknisyen için özel notlar..."></textarea>
        </div>
      </div>

      <!-- Hatırlatma Ayarları -->
      <div class="form-section">
        <h3>Hatırlatma Ayarları</h3>

        <div class="form-row">
          <div class="form-group">
            <label>
              <input type="checkbox" id="appointment-reminder-sms" name="reminderSms">
              SMS Hatırlatma Gönder
            </label>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="appointment-reminder-email" name="reminderEmail">
              <email>Email</email> Hatırlatma Gönder
            </label>
          </div>

          <div class="form-group">
            <label for="appointment-reminder-time">Hatırlatma Zamanı</label>
            <select id="appointment-reminder-time" name="reminderTime">
              <option value="1h">1 saat önce</option>
              <option value="3h">3 saat önce</option>
              <option value="1d">1 gün önce</option>
              <option value="2d">2 gün önce</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Buttons -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal('appointment-modal')">İptal</button>
        <button type="submit" class="btn btn-primary">
          <span class="btn-text">Randevu Oluştur</span>
          <span class="btn-loading" style="display: none;">Oluşturuluyor...</span>
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// Randevu için müşteri cihazlarını yükle
async function loadAppointmentDevices(customerId) {
  const deviceSelect = document.getElementById('appointment-device');

  if (!customerId) {
    deviceSelect.disabled = true;
    deviceSelect.innerHTML = '<option value="">Önce müşteri seçiniz...</option>';
    return;
  }

  try {
    showLoading('Cihazlar yükleniyor...');

    const response = await fetch(`${API_BASE_URL}/customers/${customerId}/devices`);
    const devices = await response.json();

    deviceSelect.disabled = false;
    deviceSelect.innerHTML = '<option value="">Cihaz seçiniz...</option>';

    devices.forEach(device => {
      const option = document.createElement('option');
      option.value = device.id;
      option.textContent = `${device.brand} ${device.model} (${device.serialNumber})`;
      deviceSelect.appendChild(option);
    });

    hideLoading();
  } catch (error) {
    console.error('Error loading devices:', error);
    showNotification('Cihazlar yüklenirken hata oluştu', 'error');
    hideLoading();
  }
}

// Bugünün tarihini varsayılan olarak ayarla
document.addEventListener('DOMContentLoaded', () => {
  const dateInput = document.getElementById('appointment-date');
  if (dateInput) {
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
    dateInput.min = today; // Geçmiş tarih seçilemesin
  }
});
</script>
